## Фронтенд

Нужно настроить GitHub Action на сборку и деплой фронтенда в Cloudflare Pages. В панели Cloudflare в административном интерфейсе необходимо задать поддомен, на котором будет доступен фронтенд.

## Бэкенд

### 1 GitHub

GitHub создаётся репозиторий с docker-compose для бэкенда.

### 2 Komo.do

Далее в Komo.do создаётся Stack, в котором:

— указывается репозиторий GitHub и путь к docker-compose

— задаётся папка для хранения репозитория в `/openartel/<project-name>`

— включаем вебхук для деплоя в режиме webhook force deploy

— включаются Pre Pull Images, Pre Build Images и Destroy Before Deploy для 100% обновления контейнеров

— переменные окружения задаются и живут в https://infisical-infra.openartel.com, а в Komo.do только подтягиваются на уровне контейнера через Pre Deploy с помощью скрипта, пишем:

```sh
INFISICAL_URL="https://infisical-infra.openartel.com"
INFISICAL_TOKEN=[[INFISICAL_TOKEN]]

PROJECT_ID="<project-id>"
ENVIRONMENT="dev"
ENV_FILE_PATH="/openartel/<project-name>/<any>/.env"

/gitops/fetch_env.sh "$INFISICAL_URL" "$INFISICAL_TOKEN" "$PROJECT_ID" "$ENVIRONMENT" "$ENV_FILE_PATH"
```

Краткое пояснение: доступны два пути `/gitops` и `/openartel`, проекты должны лежать в /openartel в своей уникальной папке, название Stack в Komo.do равен названию папки проекта.

### 3 Снова GitHub
После этого в GitHub в репозитории бэкенда настраивается вебхук, URL берётся из Komo.do. Это обеспечивает моментальную пересборку и деплой при обновлении кода в репозитории.

На этом этапе у нас есть триггер обновления кода, сборка и деплой. Далее делаем сервис публично доступным за Cloudflare.

### 4 GitOps инфраструктура внешнего доступа
В репозитории https://github.com/OpenArtel/openartel-infra есть две папки. В `frpc-openartel/frpc.toml` нужно настроить проксирование сервиса с сервера на VPS. А в `frps-cloudflared/config.yml` проксирование из FRPS Docker контейнера на VPS в Cloudflare Tunnel.

### 5 Cloudflare
В панели Cloudflare https://dash.cloudflare.com в разделе DNS нужно завести новый поддомен по аналогии с уже существующими записями, а именно с редиректом в туннель.

### 6 Успех
На этом сервис становится доступен пользователям, при этом закрыт за Cloudflare. 

А Вы прекрасны!
